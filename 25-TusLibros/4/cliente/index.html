<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Tus Libros</title>

  <!-- Fonts to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" />
  <!-- Icons to support Material Design -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
</head>

<body>
  <div id="root"></div>

  <script src="./lib/react.development.js" crossorigin="anonymous"></script>
  <script src="./lib/react-dom.development.js" crossorigin="anonymous"></script>
  <script src="./lib/material-ui.development.js" crossorigin="anonymous"></script>
  <script src="./lib/babel.min.js" crossorigin="anonymous"></script>
  <script src="./src/refreshbrowser.js" crossorigin="anonymous"></script>

  <!-- Libraries fallback -->
  <script>window.React || document.write('<script src="https://unpkg.com/react@16.11.0/umd/react.development.js">\x3C/script>')</script>
  <script>window.ReactDOM || document.write('<script src="https://unpkg.com/react-dom@16.11.0/umd/react-dom.development.js">\x3C/script>')</script>
  <script>window.MaterialUI || document.write('<script src="https://unpkg.com/@material-ui/core@4.6.1/umd/material-ui.development.js">\x3C/script>')</script>
  <script>window.Babel || document.write('<script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js">\x3C/script>')</script>
  <!-- end fallback -->

  <script type="text/babel" type="module">
    const {
      // theme, styles
      colors,
      createMuiTheme,
      makeStyles,
      withStyles,
      // components
      AppBar,
      Button,
      Container,
      CssBaseline,
      Icon,
      IconButton,
      InputAdornment,
      InputLabel,
      FormControl,
      Link,
      List,
      ListItem,
      ListItemIcon,
      ListItemText,
      OutlinedInput,
    	Table,
    	TableHead,
    	TableBody,
    	TableRow,
    	TableCell,
      TextField,
      ThemeProvider,
      Toolbar,
      Typography,
    } = MaterialUI;
    const theme = createMuiTheme({
      palette: {
        primary: {
          main: '#556cd6',
        },
        secondary: {
          main: '#19857b',
        },
        error: {
          main: colors.red.A400,
        },
        background: {
          default: '#fff',
          paper: '#f5f5f5',
        },
      },
    });
    
    const styles = theme => ({
      root: {
        margin: theme.spacing(6, 0, 3),
      },
      lightBulb: {
        verticalAlign: 'middle',
        // marginRight: theme.spacing(1),
      },
      rootToolBar: {
        flexGrow: 1,
      },
      menuButton: {
        marginRight: theme.spacing(2),
      },
      textField: {
        marginTop: theme.spacing(2),
        marginBottom: theme.spacing(2),
      },
      title: {
        flexGrow: 1,
      },
      rootList: {
        width: '100%',
        backgroundColor: theme.palette.background.paper,
        position: 'relative',
        overflow: 'auto',
        maxHeight: 300,
      },
      textFieldDetails: {
        margin: theme.spacing(2),
      }
    })
    
    const useStyles = makeStyles(styles);

    const request = (path) => {
      const port = 3000
    
      return fetch(`http://localhost:${port}/${path}`, {
        method: "GET",
        dataType: "JSON",
        headers: {
          "Access-Control-Request-Headers": "*"
        }
      })
    	.then((response) => response.json())
    	.then((json) => {
    		let errorMessage = json.response["error_message"]
    		if (errorMessage != undefined) {
    			throw new Error(errorMessage)
    		}
    		else {
    			return json.response
    		}
    	})
    }
    
    const handleErrors = (router, promise) => {
    	promise.catch((error) => router.navigate("/error", {errorMessage: error.message}))
    }
    class MyToolBarComponent extends React.Component {
      constructor(props) {
        super(props)
      }
    
    	onClickCatalog() {
    		this.props.router.navigate("/catalog", {})
    	}
    	
    	onClickCart() {
    		this.props.router.navigate("/cart", {})
    	}
    	
    	onClickPurchaseHistory() {
    		this.props.router.navigate("/purchaseHistory", {})
    	}
    	
    	onClickLogout() {
    		this.props.router.navigate("/", {cartID: -1})
    	}
    
      render() {
    		const {title, classes} = this.props
    
        return (
          <div className={classes.rootToolBar}>
            <AppBar position="static">
              <Toolbar>
                <Typography variant="h6" className={classes.title}>
                  {title}
                </Typography>
    						<Button
    							color="inherit"
    							onClick={() => this.onClickCatalog()}>
    							Catalog
    						</Button>
    						<Button
    							color="inherit"
    							onClick={() => this.onClickCart()}>
    							Cart
    						</Button>
    						<Button
    							color="inherit"
    							onClick={() => this.onClickPurchaseHistory()}>
    							Purchase History
    						</Button>
    						<Button
    							color="inherit"
    							onClick={() => this.onClickLogout()}>
    							Log Out
    						</Button>
              </Toolbar>
            </AppBar>
          </div>
        )
      }
    
    }
    
    // Add style
    const MyToolBar = withStyles(styles, {
      withTheme: true
    })(MyToolBarComponent)
    class CartCreationComponent extends React.Component {
      constructor(props) {
        super(props)
    
        this.state = {
    			clientID: "",
    			password: "",
    			error: false,
    			errorMessage: "",
        }
      }
    
      handleClientIDChange(event) {
        this.setState({
          clientID: event.target.value
        })
      }
    	
    	handlePasswordChange(event) {
        this.setState({
    			password: event.target.value
        })
    	}
    
      handleCreate() {
        const {clientID, password} = this.state
        request(`createCart?clientID=${clientID}&password=${password}`)
          .then((responseBody) => this.props.router.navigate("/catalog", {cartID: responseBody}))
          .catch((error) => this.setState({error: true, errorMessage: error.message}));
      }
    
    	errorMessageElement() {
    		const {error, errorMessage} = this.state
    		if (error) {
    			return <div style={{color:'red'}}>{errorMessage}</div>
    		}
    		return null
    	}
    
      render() {
        const {clientID, password} = this.state
    
        return (
          <div>
            <Typography component="h1" gutterBottom>
              Enter your Client ID and password
             </Typography>
            <InputField
    					label="Client ID"
    					value={clientID}
    					onChange={(e) => this.handleClientIDChange(e)}
    				/>
    				<InputField
    					label="Password"
    					value={password}
    					onChange={(e) => this.handlePasswordChange(e)}
    				/>
    				{this.errorMessageElement()}
            <Button
              color="inherit"
              onClick={(e) => this.handleCreate()}>
    					Log In and create a Cart
    				</Button>
          </div>
        )
      }
    }
    
    // Add style
    const CartCreationView = withStyles(styles, {
      withTheme: true
    })(CartCreationComponent)
    class CatalogComponent extends React.Component {
      constructor(props) {
        super(props)
      }
    
      render() {
        const {cartID, router} = this.props
    
        return (
          <div>
            <Typography component="h1" gutterBottom>
              Book Catalog:
    				</Typography>
    				<BookList
    					cartID={cartID}
    					quantityHeading="Quantity In Cart"
    					includeEntireCatalog
    					router={router}
    				/>
          </div>
        )
      }
    }
    
    // Add style
    const CatalogView = withStyles(styles, {
      withTheme: true
    })(CatalogComponent)
    class CartComponent extends React.Component {
      constructor(props) {
        super(props)
      }
    
      render() {
        const {cartID, router} = this.props
    		
        return (
          <div>
            <Typography component="h1" gutterBottom>
              Books that are actually in your Cart:
    				</Typography>
    				<BookList
    					cartID={cartID}
    					quantityHeading="Quantity"
    					router={router}
    				/>
          </div>
        )
      }
    }
    
    // Add style
    const CartView = withStyles(styles, {
      withTheme: true
    })(CartComponent)
    class App extends React.Component {
      constructor(props) {
        super(props);
        this.state = {
          path: "/",
    			cartID: -1,
    			errorMessage: "",
        };
      }
    
      render() {
        const router = {
          current: () => this.state.path,
          navigate: (path, state) => {
            this.setState({ ...state, path: path })
          }
        }
    		
    		let title = "Tus Libros"
        let content = "Where am I?"
    		let {path, cartID, errorMessage} = this.state
    		
    		if (cartID === -1) {
    			path = "/"
    		}
    
        if (path === "/") {
          content = (<CartCreationView
            router={router}
          />)
        } else if (path === "/catalog") {
          content = (<CatalogView
            router={router}
            cartID={this.state.cartID}
          />)
        } else if (path === "/cart") {
          content = (<CartView
            router={router}
            cartID={this.state.cartID}
          />)
        } else if (path ==="/error") {
    			content = (<ErrorView message={this.state.errorMessage} router={router} />)
    		}
    		
        return (
          <div>
            <MyToolBar
              title={title}
              router={router}
            />
            <Container maxWidth="sm">
              <div style={{ marginTop: 24, }}>
                {content}
              </div>
            </Container>
          </div>
        );
      }
    }
    class BookListComponent extends React.Component {
      constructor(props) {
        super(props)
    		
    		this.state = {bookList: []}
      }
    	
    	buildBookListFrom(catalog, cartContent, includeEntireCatalog) {
    		let bookList = []
    		
    		Object.keys(catalog).forEach((isbn) => {
    			let quantity = 0
    			if (isbn in cartContent) {
    				quantity = cartContent[isbn]
    			}
    			if (includeEntireCatalog || quantity > 0) {
    				bookList.push({
    					title: catalog[isbn].title,
    					isbn: isbn,
    					quantity: quantity,
    				})
    			}
    		})
    		
    		return bookList
    	}
    	
    	componentDidMount() {
        const {cartID, includeEntireCatalog, router} = this.props
    		
    		let catalog = {}
    		handleErrors(router, request(`catalog`)
    			.then((responseBody) => {
    				catalog = responseBody
    				return request(`listCart?cartID=${cartID}`)
    			})
    			.then((cartContent) => {
    				this.setState( {bookList: this.buildBookListFrom(catalog, cartContent, includeEntireCatalog)} )
    			})
    		)
    	}
    
    	render() {
    		const {
    			cartID,
    			quantityHeading,
    			router,
    			classes,
    		} = this.props
    		
    		const bookList = this.state.bookList
    		
    		return (
    			<Table className={classes.table} aria-label="simple table">
    				<TableHead>
    					<TableRow>
    						<TableCell>Title</TableCell>
    						<TableCell>ISBN</TableCell>
    						<TableCell align="center">{quantityHeading}</TableCell>
    					</TableRow>
    				</TableHead>
    				<TableBody>
    					{
    						bookList.map((item, index) => (
    							<TableRow key={index}>
    								<TableCell>
    									<Button onClick={()=>{}}>{item.title}</Button>
    								</TableCell>
    								<TableCell>{item.isbn}</TableCell>
    								<TableCell align="center">
    									<EditableBookQuantity cartID={cartID} isbn={item.isbn} quantity={item.quantity} router={router} />
    								</TableCell>
    							</TableRow>
    						))
    					}
    				</TableBody>
    			</Table>
        )
    	}
    }
    
    const BookList = withStyles(styles, {
      withTheme: true
    })(BookListComponent)
    class EditableBookQuantityComponent extends React.Component {
      constructor(props) {
        super(props)
    		
    		this.state = {quantity: props.quantity}
      }
    	
    	onClickAdd() {
    		const {cartID, isbn, quantity, router} = this.props
    		handleErrors(router, request(`addToCart?cartID=${cartID}&bookIsbn=${isbn}&quantity=1`)
    			.then((responseBody) => this.setState({quantity: this.state.quantity + 1}))
    		)
    	}
    	
    	onClickRemove() {
    		let quantity = this.state.quantity
    		if (quantity > 0) {
    			this.setState({quantity: quantity - 1})
    		}
    	}
    	
    	render() {
    		return (
    			<div>
    				<Button onClick={() => this.onClickAdd()}>
    					+
    				</Button>
    				
    				{this.state.quantity}
    				
    				<Button onClick={() => this.onClickRemove()}>
    					-
    				</Button>
    			</div>
    		)
    	}
    }
    
    const EditableBookQuantity = withStyles(styles, {
      withTheme: true
    })(EditableBookQuantityComponent)
    class InputFieldComponent extends React.Component {
      constructor(props) {
        super(props)
      }
    	
    	render() {
    		const {label, value, onChange, classes} = this.props
    		return (
    			<FormControl fullWidth className={classes.textField} variant="outlined">
    				<InputLabel htmlFor="outlined-adornment-amount">{label}</InputLabel>
    				<OutlinedInput
    					id="outlined-adornment-amount"
    					value={value}
    					onChange={onChange}
    					startAdornment={<InputAdornment position="start">></InputAdornment>}
    					labelWidth={60}
    					rows="1"
    				/>
    			</FormControl>
    		)
    	}
    }
    
    const InputField = withStyles(styles, {
      withTheme: true
    })(InputFieldComponent)
    class ErrorComponent extends React.Component {
      constructor(props) {
        super(props)
      }
    
    	onClickOk() {
    		this.props.router.navigate("/", {cartID: -1})
    	}
    
    	render() {
    		return (
    			<div>
    				<h1 style={{color:'red'}}>An error occurred:</h1>
    				<div style={{color:'red'}}>{this.props.message}</div>
    				<Button onClick={() => this.onClickOk()}>Ok</Button>
    			</div>
    		)
    	}
    }
    
    const ErrorView = withStyles(styles, {
      withTheme: true
    })(ErrorComponent)
    

    ///////////////////////////////////////////////////////////////////////////
    // Initial render
    //
    ReactDOM.render(
      <ThemeProvider theme={theme}>
        <CssBaseline />
        <App />
      </ThemeProvider>,
      document.getElementById('root')
    )
  </script>

  <!-- <button onclick="window.location.reload(true)">reload</button> -->
</body>

</html>
